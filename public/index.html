<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Stelligent Demo - Chart</title>
        <script src="http://code.jquery.com/jquery-latest.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
    </head>
    <body>
        <div>
            <div style="width: 50%; float: left;">
                <h2 align="center">Example Chart</h2>
                <canvas id="myChart" width="350" height="350" style="padding: 0; margin: auto; display: block;"></canvas>
            </div>
            <div style="width: 50%; margin-left: 50%">
                <h2 align="center">Last Response from API</h2>
                <p><strong><span id="lastApiUrl">&nbsp;</span></strong></p>
                <pre id="lastApiResponseText" style="white-space: pre-wrap;">&nbsp;</pre>
            </div>
        </div>

        <script>
            $(document).ready( 
                function () {
                    var ctx = document.getElementById("myChart").getContext("2d");
                    var myPieChart;
                    var updateChart = false;

                    function updateLastApi(url, xhr) {
                        document.getElementById("lastApiUrl").innerHTML = url;
                        document.getElementById("lastApiResponseText").innerHTML =
                            xhr.getAllResponseHeaders() + "\n" + xhr.responseText;
                    };

                    $.getJSON("/data", {}, function(data, status, xhr) {
                        myPieChart = new Chart(ctx).Pie(data);
                        console.log('Chart data GET status: ' + status);
                        updateLastApi("/data", xhr);
                    });

                    $("#myChart").click(function(evt) {
                        var activePoints = myPieChart.getSegmentsAtEvent(evt);
                        var colorToInc = activePoints[0].label.toLowerCase();
                        $.getJSON("/increment?color=" + colorToInc, {}, function(data, status, xhr) {
                            activePoints[0].value = data.count;
                            console.log('Color increment GET status: ' + status);
                            updateLastApi("/increment?color=" + colorToInc, xhr);
                            updateChart = true;
                        });
                    });

                    function pollForUpdates() {
                        if (!myPieChart.hasOwnProperty("segments")) {
                            return;
                        }
                        $.getJSON("/data?countsOnly=true", {}, function(data, status, xhr) {
                            var segment;
                            var segmentIndex;
                            var color;

                            updateLastApi("/data?countsOnly=true", xhr);

                            for (segmentIndex in myPieChart.segments) {
                                segment = myPieChart.segments[segmentIndex];
                                color = segment.label.toLowerCase();
                                if (data.hasOwnProperty(color) && segment.value != data[color]) {
                                    console.log('Updating count for ' + color + ' to ' + data[color]);
                                    myPieChart.segments[segmentIndex].value = data[color];
                                    updateChart = true;
                                }
                            }
                        });
                    };
                    setInterval(pollForUpdates, 5000);

                    setInterval(function() {
                        if (updateChart) {
                            myPieChart.update();
                            updateChart = false;
                        }
                    }, 100);
                }
            );
        </script>
    </body>
</html>
