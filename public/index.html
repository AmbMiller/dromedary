<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Stelligent Demo - Chart</title>
        <script src="http://code.jquery.com/jquery-latest.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
    </head>
    <body>
        <div>
            <div style="width: 50%; float: left;">
                <h2 align="center">Example Chart</h2>
                <p align="center" id="gitCommitSha">&nbsp;</p>
                <canvas id="myChart" width="350" height="350" style="padding: 0; margin: auto; display: block;"></canvas>
            </div>
            <div style="width: 50%; margin-left: 50%">
                <h2 align="center">Last 3 Responses from API</h2>
                <p><strong><span id="lastApiUrl1">&nbsp;</span></strong></p>
                <pre id="lastApiResponseText1" style="white-space: pre-wrap;">&nbsp;</pre>
                <p><strong><span id="lastApiUrl2">&nbsp;</span></strong></p>
                <pre id="lastApiResponseText2" style="white-space: pre-wrap;">&nbsp;</pre>
                <p><strong><span id="lastApiUrl3">&nbsp;</span></strong></p>
                <pre id="lastApiResponseText3" style="white-space: pre-wrap;">&nbsp;</pre>
            </div>
        </div>

        <script>
            function chartHandler () {
                var ctx = document.getElementById("myChart").getContext("2d");
                var myPieChart;
                var commitSha = "unknown";
                var updateChart = false;
                var reloadPage = false;

                function updateLastApi(url, xhr) {
                    document.getElementById("lastApiUrl3").innerHTML =
                        document.getElementById("lastApiUrl2").innerHTML;
                    document.getElementById("lastApiResponseText3").innerHTML =
                        document.getElementById("lastApiResponseText2").innerHTML;
                    document.getElementById("lastApiUrl2").innerHTML =
                        document.getElementById("lastApiUrl1").innerHTML;
                    document.getElementById("lastApiResponseText2").innerHTML =
                        document.getElementById("lastApiResponseText1").innerHTML;
                    document.getElementById("lastApiUrl1").innerHTML =
                        location.protocol + "//" + location.host + url;
                    document.getElementById("lastApiResponseText1").innerHTML =
                        xhr.getAllResponseHeaders() + "\n" + xhr.responseText;
                };

                $.getJSON("/sha", {}, function(data, status, xhr) {
                    commitSha = data.sha;
                    document.getElementById("gitCommitSha").innerHTML = commitSha;
                    updateLastApi("/sha", xhr);
                });

                $.getJSON("/data", {}, function(data, status, xhr) {
                    myPieChart = new Chart(ctx).Pie(data);
                    console.log('Chart data GET status: ' + status);
                    updateLastApi("/data", xhr);
                });

                $("#myChart").click(function(evt) {
                    var activePoints = myPieChart.getSegmentsAtEvent(evt);
                    var colorToInc = activePoints[0].label.toLowerCase();
                    $.getJSON("/increment?color=" + colorToInc, {}, function(data, status, xhr) {
                        activePoints[0].value = data.count;
                        console.log('Color increment GET status: ' + status);
                        updateLastApi("/increment?color=" + colorToInc, xhr);
                        updateChart = true;
                    });
                });

                function pollForUpdates() {
                    if (!myPieChart.hasOwnProperty("segments")) {
                        return;
                    }
                    $.getJSON("/data?countsOnly=true", {}, function(data, status, xhr) {
                        var segment;
                        var segmentIndex;
                        var color;
                        var doUpdate = false;


                        for (segmentIndex in myPieChart.segments) {
                            segment = myPieChart.segments[segmentIndex];
                            color = segment.label.toLowerCase();
                            if (data.hasOwnProperty(color) && segment.value != data[color]) {
                                console.log('Updating count for ' + color + ' to ' + data[color]);
                                myPieChart.segments[segmentIndex].value = data[color];
                                doUpdate = true;
                            }
                        }
                        if (doUpdate) {
                            updateLastApi("/data?countsOnly=true", xhr);
                            updateChart = true;
                        }
                    });
                };
                setInterval(pollForUpdates, 5000);

                function pollForNewSha() {
                    $.getJSON("/sha", {}, function(data, status, xhr) {
                        if (commitSha != data.sha) {
                            reloadPage = true;
                        }
                    });
                };
                setInterval(pollForNewSha, 1000);

                setInterval(function() {
                    if (updateChart) {
                        myPieChart.update();
                        updateChart = false;
                    }
                    if (reloadPage) {
                        location.reload(true);
                    }
                }, 100);
            }
            $(document).ready(chartHandler);
        </script>
    </body>
</html>
